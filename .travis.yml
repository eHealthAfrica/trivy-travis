language: generic

services:
  - docker

before_script:
  # Install Trivy
  - wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.56.2_Linux-64bit.deb
  - sudo dpkg -i trivy_0.56.2_Linux-64bit.deb

script:
  # Build Docker image
  - docker build -t trivy-travis:latest .
  # Scan Docker image with Trivy and save the report in JSON format
  - trivy image --exit-code 1 --severity HIGH,CRITICAL --format json -o $(pwd)/trivy-report.json trivy-travis:latest || true
  # Confirm if trivy-report.json was generated
  - ls -la $(pwd)/trivy-report.json  # Check if trivy-report.json exists and display its details

after_script:
  - echo "Uploading report to DefectDojo..."
  - |
    curl -X POST "${DEFECTDOJO_URL}" \
      -H 'accept: application/json' \
      -H "Authorization: ${DEFECTDOJO_API_TOKEN}" \
      -H 'Content-Type: multipart/form-data' \
      -F "test=33" \
      -F "file=@$(pwd)/trivy-report.json;type=application/json" \
      -F "scan_type=Trivy Scan" \
      -F "tags=sample" \
      --max-time 300
